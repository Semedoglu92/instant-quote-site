<script>
const N8N_URL = "https://instantrepair.up.railway.app/webhook/quote";

const out = (t) => (document.getElementById("output").textContent = t);

document.getElementById("quoteForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  // basic client-side checks
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (!/^\S+@\S+\.\S+$/.test(email)) {
    out("Please enter a valid email."); return;
  }
  if (!/^[0-9+\-\s().]{7,}$/.test(phone)) {
    out("Please enter a valid phone number."); return;
  }

  const payload = {
    name: document.getElementById("name").value.trim(),
    phone,
    brand: document.getElementById("brand").value.trim(),
    issue: document.getElementById("issue").value.trim(),
    email,
    deviceType: document.getElementById("deviceType").value.trim(),
    model: document.getElementById("model").value.trim(),
    submittedAt: new Date().toISOString()
  };

  const btn = e.submitter || document.querySelector("#quoteForm button[type=submit]");
  btn && (btn.disabled = true);
  out("Getting your quote...");

  try {
    const res = await fetch(N8N_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { /* maybe text/plain */ }

    if (!res.ok) {
      out(data?.message || `Server error: ${res.status} ${raw?.slice(0,200)}`);
      return;
    }

    const msg =
      data.message ||
      (data.quote != null || data.turnaround
        ? `Quote: ${data.quote ?? "N/A"} • Turnaround: ${data.turnaround ?? "N/A"}`
        : raw || "Success, but no message returned.");

    out(msg);
  } catch (err) {
    out("Sorry—couldn’t fetch your quote. Try again shortly.");
  } finally {
    btn && (btn.disabled = false);
  }
});
</script>
